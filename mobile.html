<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DT Driver - GPS Logger</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- FIREBASE SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
    
    <!-- GOOGLE MAPS -->
    <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY&libraries=geometry"></script>
    
    <style>
        /* ==============================
           STYLE CSS MOBILE ENHANCED
        ============================== */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .login-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
        }

        .driver-app {
            background: #f8f9fa;
            min-height: 100vh;
        }

        .vehicle-info {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .stats-card {
            background: white;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }

        .speed-gauge {
            font-size: 2.5rem;
            font-weight: bold;
            color: #28a745;
            margin: 5px 0;
        }

        .distance-counter {
            font-size: 2rem;
            font-weight: bold;
            color: #007bff;
            margin: 5px 0;
        }

        .connection-status {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 5px;
        }

        .connected { background-color: #28a745; }
        .connecting { background-color: #ffc107; }
        .disconnected { background-color: #dc3545; }

        .control-btn {
            margin-bottom: 10px;
            padding: 12px;
            border-radius: 10px;
            font-weight: bold;
            border: none;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.2);
        }

        .data-log {
            max-height: 200px;
            overflow-y: auto;
            font-size: 0.8rem;
        }

        /* Enhanced Chat Interface Styles */
        .chat-toggle-btn {
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            border-radius: 25px;
            padding: 10px 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .chat-window {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 320px;
            height: 400px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            z-index: 1001;
            display: none;
            flex-direction: column;
        }

        .chat-window.show {
            display: flex;
        }

        .chat-header {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            padding: 15px;
            border-radius: 15px 15px 0 0;
            display: flex;
            justify-content: between;
            align-items: center;
        }

        .chat-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            background: #f8f9fa;
        }

        .chat-input-container {
            padding: 15px;
            border-top: 1px solid #dee2e6;
            background: white;
            border-radius: 0 0 15px 15px;
        }

        .message {
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 10px;
            max-width: 80%;
            word-wrap: break-word;
        }

        .message.sent {
            background: #007bff;
            color: white;
            margin-left: auto;
        }

        .message.received {
            background: #e9ecef;
            color: #333;
        }

        /* Animations */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .chat-window {
                width: 300px;
                height: 350px;
            }
            
            .speed-gauge {
                font-size: 2rem;
            }
            
            .distance-counter {
                font-size: 1.5rem;
            }
        }

        @media (max-width: 480px) {
            .chat-window {
                width: 280px;
                height: 300px;
                right: 10px;
                bottom: 70px;
            }
            
            .chat-toggle-btn {
                right: 10px;
                bottom: 10px;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="container-fluid min-vh-100 d-flex align-items-center justify-content-center p-3">
        <div class="login-container p-4 w-100" style="max-width: 400px;" id="loginScreen">
            <div class="text-center mb-4">
                <div class="bg-primary text-white rounded-circle d-inline-flex align-items-center justify-content-center" 
                     style="width: 80px; height: 80px; font-size: 2rem;">
                    üöö
                </div>
                <h3 class="mt-3 text-dark">DT GPS Logger</h3>
                <p class="text-muted">Login Driver Dump Truck</p>
            </div>
            
            <form id="loginForm">
                <div class="mb-3">
                    <label class="form-label">Nama Driver</label>
                    <input type="text" class="form-control" id="driverName" placeholder="Masukkan nama lengkap" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Nomor Unit DT</label>
                    <select class="form-select" id="unitNumber" required>
                        <option value="">Pilih Unit DT</option>
                        <option value="DT-06">DT-06 - Dump Truck 2018</option>
                        <option value="DT-07">DT-07 - Dump Truck 2018</option>
                        <option value="DT-12">DT-12 - Dump Truck 2020</option>
                        <option value="DT-13">DT-13 - Dump Truck 2020</option>
                        <option value="DT-15">DT-15 - Dump Truck 2020</option>
                        <option value="DT-16">DT-16 - Dump Truck 2020</option>
                        <option value="DT-17">DT-17 - Dump Truck 2020</option>
                        <option value="DT-18">DT-18 - Dump Truck 2020</option>
                        <option value="DT-23">DT-23 - Dump Truck 2021</option>
                        <option value="DT-24">DT-24 - Dump Truck 2021</option>
                        <option value="DT-25">DT-25 - Dump Truck 2022</option>
                        <option value="DT-26">DT-26 - Dump Truck 2022</option>
                        <option value="DT-27">DT-27 - Dump Truck 2022</option>
                        <option value="DT-28">DT-28 - Dump Truck 2022</option>
                        <option value="DT-29">DT-29 - Dump Truck 2022</option>
                        <option value="DT-32">DT-32 - Dump Truck 2024</option>
                        <option value="DT-33">DT-33 - Dump Truck 2025</option>
                        <option value="DT-34">DT-34 - Dump Truck 2025</option>
                        <option value="DT-35">DT-35 - Dump Truck 2025</option>
                        <option value="DT-36">DT-36 - Dump Truck 2020</option>
                        <option value="DT-37">DT-37 - Dump Truck 2020</option>
                        <option value="DT-38">DT-38 - Dump Truck 2020</option>
                        <option value="DT-39">DT-39 - Dump Truck 2020</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary w-100 py-2 fw-bold">
                    üöÄ Login & Start GPS
                </button>
            </form>
        </div>
    </div>

    <!-- Driver App Screen -->
    <div class="driver-app" id="driverApp" style="display: none;">
        <!-- Header -->
        <div class="row align-items-center m-3">
            <div class="col-8">
                <h5 class="mb-0">üöö DT Driver</h5>
                <small class="text-muted" id="currentTime">--:--:--</small>
            </div>
            <div class="col-4 text-end">
                <span class="connection-status" id="connectionDot"></span>
                <span id="connectionStatus">MENYAMBUNG...</span>
            </div>
        </div>

        <!-- Vehicle Info -->
        <div class="vehicle-info p-3 m-3">
            <div class="row align-items-center">
                <div class="col-8">
                    <h4 class="mb-1 fw-bold" id="vehicleName">-</h4>
                    <small>Driver: <span id="driverDisplayName">-</span></small>
                </div>
                <div class="col-4 text-end">
                    <div class="bg-white text-dark rounded px-2 py-1">
                        <small class="fw-bold" id="vehicleStatus">READY</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Real-time Stats -->
        <div class="row m-2">
            <div class="col-6">
                <div class="stats-card text-center">
                    <small class="d-block">KECEPATAN</small>
                    <div class="speed-gauge" id="currentSpeed">0</div>
                    <small>km/h</small>
                </div>
            </div>
            <div class="col-6">
                <div class="stats-card text-center">
                    <small class="d-block">JARAK HARI INI</small>
                    <div class="distance-counter" id="todayDistance">0.0</div>
                    <small>kilometer</small>
                </div>
            </div>
        </div>

        <!-- GPS Data -->
        <div class="card m-3">
            <div class="card-body">
                <h6 class="card-title">üìç DATA GPS REAL-TIME</h6>
                <div class="gps-data p-3">
                    <div class="row">
                        <div class="col-6 mb-2">
                            <small class="text-muted d-block">LATITUDE</small>
                            <strong id="currentLat">-</strong>
                        </div>
                        <div class="col-6 mb-2">
                            <small class="text-muted d-block">LONGITUDE</small>
                            <strong id="currentLng">-</strong>
                        </div>
                        <div class="col-6">
                            <small class="text-muted d-block">AKURASI</small>
                            <strong id="gpsAccuracy">-</strong>
                        </div>
                        <div class="col-6">
                            <small class="text-muted d-block">ARAH</small>
                            <strong id="gpsBearing">-</strong>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Control Buttons -->
        <div class="row m-2">
            <div class="col-6">
                <button class="btn btn-success w-100 control-btn" onclick="startJourney()">
                    üöÄ MULAI
                </button>
            </div>
            <div class="col-6">
                <button class="btn btn-warning w-100 control-btn" onclick="pauseJourney()">
                    ‚è∏Ô∏è JEDA
                </button>
            </div>
            <div class="col-6">
                <button class="btn btn-info w-100 control-btn" onclick="reportIssue()">
                    üö® LAPOR
                </button>
            </div>
            <div class="col-6">
                <button class="btn btn-danger w-100 control-btn" onclick="endJourney()">
                    ‚úÖ SELESAI
                </button>
            </div>
        </div>

        <!-- Session Info -->
        <div class="card m-3">
            <div class="card-body">
                <h6 class="card-title">üìä INFO SESI</h6>
                <div class="row text-center">
                    <div class="col-4">
                        <small class="text-muted d-block">DURASI</small>
                        <strong id="sessionDuration">00:00:00</strong>
                    </div>
                    <div class="col-4">
                        <small class="text-muted d-block">DATA POINTS</small>
                        <strong id="dataPoints">0</strong>
                    </div>
                    <div class="col-4">
                        <small class="text-muted d-block">RATA-RATA</small>
                        <strong id="avgSpeed">0</strong>
                    </div>
                </div>
            </div>
        </div>

        <!-- Enhanced Data Logger -->
        <div class="card m-3">
            <div class="card-body">
                <h6 class="card-title">üìù ENHANCED DATA LOGGER</h6>
                <div class="data-log" id="dataLogs">
                    <div class="alert alert-info py-2 mb-2">
                        <small>System: Menunggu inisialisasi GPS...</small>
                    </div>
                </div>
                <div class="mt-2">
                    <button class="btn btn-sm btn-outline-primary w-100" onclick="exportGPSData()">
                        üì§ Export Data GPS
                    </button>
                </div>
            </div>
        </div>

        <!-- Logout Button -->
        <div class="m-3">
            <button class="btn btn-danger w-100 py-2 fw-bold" onclick="logout()">
                üîì Logout
            </button>
        </div>
    </div>

    <!-- ‚úÖ ENHANCED CHAT INTERFACE -->
    <div id="chatContainer">
        <!-- Chat Toggle Button -->
        <button id="chatToggle" class="btn btn-primary position-fixed chat-toggle-btn" 
                onclick="toggleChat()">
            üí¨ Chat <span id="unreadBadge" class="badge bg-danger" style="display: none;"></span>
        </button>
        
        <!-- Chat Window -->
        <div id="chatWindow" class="chat-window">
            <div class="chat-header">
                <h6 class="mb-0">üí¨ Chat dengan Monitor</h6>
                <button type="button" class="btn-close" onclick="toggleChat()"></button>
            </div>
            
            <div id="chatMessages" class="chat-messages">
                <div class="chat-placeholder text-center text-muted py-4">
                    <small>Mulai percakapan dengan monitor...</small>
                </div>
            </div>
            
            <div class="chat-input-container">
                <div class="input-group">
                    <input type="text" id="chatInput" class="form-control" 
                           placeholder="Ketik pesan..." 
                           onkeypress="handleChatInput(event)">
                    <button class="btn btn-primary" type="button" 
                            onclick="sendChatMessage()">
                        Kirim
                    </button>
                </div>
                <small class="text-muted">Tekan Enter untuk mengirim</small>
            </div>
        </div>
    </div>

    <script>
        // ==============================
        // KONFIGURASI FIREBASE & INISIALISASI
        // ==============================
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT.firebaseapp.com",
            databaseURL: "https://YOUR_PROJECT.firebaseio.com",
            projectId: "YOUR_PROJECT",
            storageBucket: "YOUR_PROJECT.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // Inisialisasi Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // ==============================
        // VARIABEL GLOBAL & STATE MANAGEMENT
        // ==============================
        let currentUser = null;
        let currentSession = null;
        let watchId = null;
        let sessionStartTime = null;
        let sessionTimer = null;
        let totalDistance = 0;
        let lastPosition = null;
        let dataPointsCount = 0;
        let totalSpeed = 0;
        let isJourneyActive = false;
        let chatListener = null;

        // ==============================
        // FUNGSI UTAMA - AUTH & SESSION
        // ==============================
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const driverName = document.getElementById('driverName').value.trim();
            const unitNumber = document.getElementById('unitNumber').value;
            
            if (!driverName || !unitNumber) {
                alert('Harap isi semua field!');
                return;
            }

            currentUser = {
                name: driverName,
                unit: unitNumber,
                loginTime: new Date().toISOString(),
                sessionId: generateSessionId()
            };

            // Simpan data user ke localStorage
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            
            // Update UI
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('driverApp').style.display = 'block';
            document.getElementById('vehicleName').textContent = unitNumber;
            document.getElementById('driverDisplayName').textContent = driverName;
            
            // Mulai update waktu
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);
            
            // Inisialisasi GPS
            initializeGPS();
            
            // Setup chat
            initializeChat();
            
            // Log aktivitas
            addDataLog('System', 'Login berhasil. GPS monitoring aktif.');
        });

        function generateSessionId() {
            return 'SESSION_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        function updateCurrentTime() {
            const now = new Date();
            document.getElementById('currentTime').textContent = 
                now.toLocaleTimeString('id-ID');
        }

        // ==============================
        // FUNGSI GPS & TRACKING
        // ==============================
        function initializeGPS() {
            if (!navigator.geolocation) {
                addDataLog('System', 'ERROR: GPS tidak didukung oleh browser.');
                return;
            }

            const options = {
                enableHighAccuracy: true,
                timeout: 5000,
                maximumAge: 0
            };

            watchId = navigator.geolocation.watchPosition(
                handleGPSSuccess,
                handleGPSError,
                options
            );

            updateConnectionStatus('connected');
        }

        function handleGPSSuccess(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            const accuracy = position.coords.accuracy;
            const speed = position.coords.speed ? (position.coords.speed * 3.6).toFixed(1) : '0';
            const bearing = position.coords.heading || '-';

            // Update UI
            document.getElementById('currentLat').textContent = lat.toFixed(6);
            document.getElementById('currentLng').textContent = lng.toFixed(6);
            document.getElementById('gpsAccuracy').textContent = accuracy.toFixed(1) + ' m';
            document.getElementById('currentSpeed').textContent = speed;
            document.getElementById('gpsBearing').textContent = bearing !== '-' ? bearing + '¬∞' : '-';

            // Hitung jarak jika perjalanan aktif
            if (isJourneyActive && lastPosition) {
                const distance = calculateDistance(
                    lastPosition.lat, lastPosition.lng,
                    lat, lng
                );
                totalDistance += distance;
                document.getElementById('todayDistance').textContent = totalDistance.toFixed(2);
            }

            // Update statistik
            dataPointsCount++;
            totalSpeed += parseFloat(speed);
            const avgSpeed = dataPointsCount > 0 ? (totalSpeed / dataPointsCount).toFixed(1) : '0';
            document.getElementById('dataPoints').textContent = dataPointsCount;
            document.getElementById('avgSpeed').textContent = avgSpeed;

            // Simpan posisi terakhir
            lastPosition = { lat, lng, timestamp: Date.now() };

            // Kirim ke Firebase jika perjalanan aktif
            if (isJourneyActive && currentUser) {
                sendToFirebase({
                    lat,
                    lng,
                    speed: parseFloat(speed),
                    accuracy,
                    bearing,
                    timestamp: Date.now(),
                    sessionId: currentUser.sessionId,
                    unit: currentUser.unit,
                    driver: currentUser.name
                });
            }
        }

        function handleGPSError(error) {
            let message = 'GPS Error: ';
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    message += 'Akses GPS ditolak';
                    break;
                case error.POSITION_UNAVAILABLE:
                    message += 'Posisi tidak tersedia';
                    break;
                case error.TIMEOUT:
                    message += 'Timeout mendapatkan posisi';
                    break;
                default:
                    message += 'Error tidak diketahui';
                    break;
            }
            
            addDataLog('GPS', message);
            updateConnectionStatus('disconnected');
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Radius bumi dalam km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // ==============================
        // FUNGSI JOURNEY MANAGEMENT
        // ==============================
        function startJourney() {
            isJourneyActive = true;
            sessionStartTime = Date.now();
            document.getElementById('vehicleStatus').textContent = 'ACTIVE';
            addDataLog('Journey', 'Perjalanan dimulai');
            
            // Start session timer
            sessionTimer = setInterval(updateSessionTimer, 1000);
        }

        function pauseJourney() {
            isJourneyActive = false;
            document.getElementById('vehicleStatus').textContent = 'PAUSED';
            addDataLog('Journey', 'Perjalanan dijeda');
        }

        function endJourney() {
            isJourneyActive = false;
            if (sessionTimer) {
                clearInterval(sessionTimer);
                sessionTimer = null;
            }
            
            document.getElementById('vehicleStatus').textContent = 'COMPLETED';
            addDataLog('Journey', 'Perjalanan selesai');
            
            // Reset session timer
            document.getElementById('sessionDuration').textContent = '00:00:00';
        }

        function reportIssue() {
            const issue = prompt('Jelaskan masalah yang terjadi:');
            if (issue) {
                addDataLog('Issue', 'Laporan: ' + issue);
                // Kirim ke Firebase
                sendToFirebase({
                    type: 'issue_report',
                    message: issue,
                    timestamp: Date.now(),
                    unit: currentUser.unit,
                    driver: currentUser.name
                });
            }
        }

        function updateSessionTimer() {
            if (sessionStartTime) {
                const duration = Date.now() - sessionStartTime;
                const hours = Math.floor(duration / 3600000);
                const minutes = Math.floor((duration % 3600000) / 60000);
                const seconds = Math.floor((duration % 60000) / 1000);
                
                document.getElementById('sessionDuration').textContent = 
                    `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
        }

        // ==============================
        // FUNGSI FIREBASE INTEGRATION
        // ==============================
        function sendToFirebase(data) {
            const timestamp = Date.now();
            const ref = database.ref('gps_data/' + currentUser.unit + '/' + timestamp);
            
            ref.set(data)
                .then(() => {
                    updateConnectionStatus('connected');
                })
                .catch((error) => {
                    console.error('Firebase error:', error);
                    updateConnectionStatus('disconnected');
                    addDataLog('Firebase', 'Gagal mengirim data: ' + error.message);
                });
        }

        function updateConnectionStatus(status) {
            const dot = document.getElementById('connectionDot');
            const statusText = document.getElementById('connectionStatus');
            
            dot.className = 'connection-status ' + status;
            
            switch(status) {
                case 'connected':
                    statusText.textContent = 'TERHUBUNG';
                    break;
                case 'connecting':
                    statusText.textContent = 'MENYAMBUNG...';
                    break;
                case 'disconnected':
                    statusText.textContent = 'TERPUTUS';
                    break;
            }
        }

        // ==============================
        // FUNGSI CHAT SYSTEM
        // ==============================
        function initializeChat() {
            if (!currentUser) return;
            
            // Setup listener untuk pesan baru
            chatListener = database.ref('chat/' + currentUser.unit).on('child_added', (snapshot) => {
                const message = snapshot.val();
                displayChatMessage(message, false);
                updateUnreadBadge();
            });
        }

        function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message || !currentUser) return;
            
            const chatData = {
                message: message,
                sender: currentUser.name,
                timestamp: Date.now(),
                type: 'sent'
            };
            
            // Kirim ke Firebase
            database.ref('chat/' + currentUser.unit).push(chatData);
            
            // Tampilkan di UI
            displayChatMessage(chatData, true);
            
            // Clear input
            input.value = '';
        }

        function displayChatMessage(message, isSent) {
            const messagesContainer = document.getElementById('chatMessages');
            const placeholder = messagesContainer.querySelector('.chat-placeholder');
            
            if (placeholder) {
                placeholder.remove();
            }
            
            const messageElement = document.createElement('div');
            messageElement.className = `message ${isSent ? 'sent' : 'received'}`;
            messageElement.innerHTML = `
                <div class="fw-bold">${message.sender}</div>
                <div>${message.message}</div>
                <small class="d-block mt-1 opacity-75">
                    ${new Date(message.timestamp).toLocaleTimeString('id-ID')}
                </small>
            `;
            
            messagesContainer.appendChild(messageElement);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function toggleChat() {
            const chatWindow = document.getElementById('chatWindow');
            const unreadBadge = document.getElementById('unreadBadge');
            
            chatWindow.classList.toggle('show');
            
            if (chatWindow.classList.contains('show')) {
                unreadBadge.style.display = 'none';
            }
        }

        function handleChatInput(event) {
            if (event.key === 'Enter') {
                sendChatMessage();
            }
        }

        function updateUnreadBadge() {
            const chatWindow = document.getElementById('chatWindow');
            const unreadBadge = document.getElementById('unreadBadge');
            
            if (!chatWindow.classList.contains('show')) {
                const currentCount = parseInt(unreadBadge.textContent) || 0;
                unreadBadge.textContent = currentCount + 1;
                unreadBadge.style.display = 'inline';
            }
        }

        // ==============================
        // FUNGSI UTILITAS
        // ==============================
        function addDataLog(type, message) {
            const logContainer = document.getElementById('dataLogs');
            const logEntry = document.createElement('div');
            logEntry.className = 'alert alert-info py-2 mb-2';
            logEntry.innerHTML = `
                <small><strong>${type}:</strong> ${message} <em>${new Date().toLocaleTimeString('id-ID')}</em></small>
            `;
            
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
            
            // Hapus log lama jika terlalu banyak
            if (logContainer.children.length > 50) {
                logContainer.removeChild(logContainer.firstChild);
            }
        }

        function exportGPSData() {
            if (!currentUser) return;
            
            const data = {
                driver: currentUser.name,
                unit: currentUser.unit,
                exportTime: new Date().toISOString(),
                totalDistance: totalDistance,
                dataPoints: dataPointsCount
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `gps_data_${currentUser.unit}_${Date.now()}.json`;
            a.click();
            
            addDataLog('Export', 'Data GPS berhasil diexport');
        }

        function logout() {
            // Cleanup
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
            }
            if (sessionTimer) {
                clearInterval(sessionTimer);
            }
            if (chatListener) {
                database.ref('chat/' + currentUser.unit).off('child_added', chatListener);
            }
            
            // Clear data
            localStorage.removeItem('currentUser');
            currentUser = null;
            
            // Reset UI
            document.getElementById('driverApp').style.display = 'none';
            document.getElementById('loginScreen').style.display = 'block';
            document.getElementById('loginForm').reset();
            
            addDataLog('System', 'Logout berhasil');
        }

        // ==============================
        // AUTO-RECONNECT & PERSISTENCE
        // ==============================
        window.addEventListener('load', function() {
            // Cek jika user sudah login sebelumnya
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('driverApp').style.display = 'block';
                document.getElementById('vehicleName').textContent = currentUser.unit;
                document.getElementById('driverDisplayName').textContent = currentUser.name;
                
                updateCurrentTime();
                setInterval(updateCurrentTime, 1000);
                initializeGPS();
                initializeChat();
                
                addDataLog('System', 'Session dipulihkan. GPS monitoring aktif.');
            }
        });

        window.addEventListener('online', function() {
            updateConnectionStatus('connected');
            addDataLog('System', 'Koneksi internet pulih');
        });

        window.addEventListener('offline', function() {
            updateConnectionStatus('disconnected');
            addDataLog('System', 'Koneksi internet terputus');
        });
    </script>
</body>
</html>
